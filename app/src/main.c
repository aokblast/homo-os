#include "drivers/homo_fs.h"
#include <assert.h>
#include <stdio.h>
#include <zephyr/fs/fs.h>
#include <zephyr/fs/fs_interface.h>
#include <zephyr/logging/log.h>
#include <zephyr/net/http/server.h>
#include <zephyr/net/http/service.h>

LOG_MODULE_REGISTER(net_http_server_sample, LOG_LEVEL_DBG);

static uint16_t http_service_port = 1919;

HTTP_SERVICE_DEFINE(homo, NULL, &http_service_port, 10, 10, NULL, NULL);

extern const unsigned char homo_fs_data_start[];
extern const unsigned char homo_fs_data_end[];
extern const unsigned char homo_fs_data_size[];

static struct homo_fs_filesystem_param fs_param;

static struct homo_fs_backend_param fs_backend_params = {
    .base_addr = homo_fs_data_start,
    .size = (int32_t)homo_fs_data_size,
    .keys = "5ZCJ5oGp44CC5q24",
    .ivs = "5bCP6LGs5Y2a6Z2I",
};

static struct fs_mount_t mp = {
    .type = FS_TYPE_EXTERNAL_BASE,
    .storage_dev = &fs_backend_params,
    .fs_data = &fs_param,
    .flags = 0,
    .mnt_point = "/server",
};

extern void RC4(char *key, char *plaintext, unsigned char *ciphertext, int len);

HTTP_SERVER_REGISTER_HEADER_CAPTURE(capture_user_agent, "HOMO-KEY");
static int dyn_handler(struct http_client_ctx *client,
                       enum http_data_status status,
                       const struct http_request_ctx *request_ctx,
                       struct http_response_ctx *response_ctx,
                       void *user_data) {
  enum http_method method = client->method;
  if (request_ctx->header_count == 0 || strlen(request_ctx->headers[0].value) != 5 || request_ctx->data_len <= 6) // key: 48763
  {
    dead:
    response_ctx->status = HTTP_418_IM_A_TEAPOT;
    response_ctx->body_len = 0;
    response_ctx->final_chunk = true;
    return 0;
  }
  RC4(request_ctx->headers[0].value, request_ctx->data, request_ctx->data, request_ctx->data_len);
  if (
    request_ctx->data[0] == 'h' && \
    request_ctx->data[1] == 'i' && \
    request_ctx->data[2] == 't' && \
    request_ctx->data[3] == 'c' && \
    request_ctx->data[4] == 'o' && \
    request_ctx->data[5] == 'n'
  )
  {
    response_ctx->status = HTTP_200_OK;
    response_ctx->body = request_ctx->data;
    response_ctx->body_len = request_ctx->data_len;
    response_ctx->final_chunk = true;
  }
  else
    goto dead;

  return 0;
}

struct http_resource_detail_dynamic dyn_resource_detail = {
    .common =
        {
            .type = HTTP_RESOURCE_TYPE_DYNAMIC,
            .bitmask_of_supported_http_methods = BIT(HTTP_GET) | BIT(HTTP_POST),
        },
    .cb = dyn_handler,
    .user_data = NULL,
};
static struct http_resource_detail_static_fs static_file_resource_detail = {
    .common =
        {
            .type = HTTP_RESOURCE_TYPE_STATIC_FS,
            .bitmask_of_supported_http_methods = BIT(HTTP_GET),
        },
    .fs_path = "/server/public"};

HTTP_RESOURCE_DEFINE(static_file_resource, homo, "/*",
                     &static_file_resource_detail);
HTTP_RESOURCE_DEFINE(dyn_resource, homo, "/sankai", &dyn_resource_detail);

int main(void) {
  printf("Homo OS v114.514 start\n");
  printf("%s\n", "#############################################################"
                 "#########%%%%%%%%%%%%%%%%%%%%@@@@@@%%%%%\n"
                 "#############################################################"
                 "#######%%%%%##**++++++=====++*##%%%@@@%%\n"
                 "#############################################################"
                 "##########*++===++**+=-:::::::--=+*##%%%\n"
                 "%##########################################################%%"
                 "%%%%##%##*+==++****+=-::::-::::-++****#%\n"
                 "%%%%###################################################%%%%%%"
                 "%%%%%%%##*+***#*+=::::::=++++===+****+**\n"
                 "=*#%%%############################################%%%%%%#####"
                 "##%%%%%%%#######*+=-==----===-----------\n"
                 "::=+#%%%######################################%%%%####*******"
                 "****###%%%%%%%%##*+++++==--:::::::::::::\n"
                 ".:::-+#%%%%#################################%%%%###**++++++++"
                 "++++++*###%%%%%%%%%###%##+-:::::::::::::\n"
                 "::...:-+*#%%%#############################%%%%%##**++++++++++"
                 "++++++++**##%%%%%%%%%%%%%*-:::::::::::::\n"
                 ":::....::=+#%%%%######################%%%%%%%##***+++++++++++"
                 "+++++++++***##%%%%%%%%%%%*=:::::::::::::\n"
                 ":::::::...:-+#%%%%########%%%%#*+==+#%%%%%##****+++++++++++++"
                 "+++++++++++***##%%%%%%%%%#+---::::::::::\n"
                 "::::::::...::-=*#%%%%%%%#*++=-:::=*#%@%###**********+++++++++"
                 "+++++++++++++**##%%%%%%%%%*+===--:::::::\n"
                 "::::::::::....::=+*#*+=--::::::-+#%%%#*********#####***++++++"
                 "++++++++++++++**###%%%%%%%#*+=---:::::::\n"
                 "::::::::::::::::::::::::....:-=*###**************####***+++++"
                 "+++++++++++++++***##%%%%%%%#*=--::::::::\n"
                 ":::::::::::::::::::::::::::-=+****++++++++*******#####**+++++"
                 "++++++++++++++++***##%%%%%%%#*=-::::::::\n"
                 ":::::::::::::::::::::::::-=+*****++++++++++*******####***++++"
                 "+++++++++++++++++***##%%%%%%#*+=::::::::\n"
                 ":::::::::::::::::::::::-=******+++++++++++++******#####**++++"
                 "+++++++++++++++++***###%%%%%%%*+-:::::::\n"
                 "::::::::::::::::::::::-+*#****+++++++++++++++*****#####***+++"
                 "+++++++++++++++++****###%%%%%%#*=-::::::\n"
                 "::::::::::::::::::::-+*##****+++++++++++++++++*****####***+++"
                 "+++++++++++++*********##%%%%%%%#+-::::::\n"
                 "::::::::::::::::::-+*####****+++++++++++++++++++++*******++++"
                 "*++++++++++************##%%%%%%#+-::::::\n"
                 ":::::::::::::::::=*####****+++++++++++++++++++++++++*********"
                 "**+++++++++************##%%%%%%#+:::::::\n"
                 ":::::::::::::::-+*###*****++++++++++*********++++++++*****###"
                 "#**********************###%%%%%#+-::::::\n"
                 ":::::::::::::-=+###*****+++++++++++******###**++++++****#####"
                 "###*********************##%%%%%%*=::::::\n"
                 "::::::::::::-+*###*****++++++++++*******##%%#*+++++****######"
                 "########***************####%%%%%%*=:::::\n"
                 ":::::::::::-+###******++++++++**********#####*********#***###"
                 "####%%%##***************###%%%%%%#*=-:::\n"
                 ":::::::::::=*##*****+++++++****************#########*********"
                 "*****#####**************####%%%%%%%*=-::\n"
                 "::::::::::=*##*****++++++****########********##%%#####*******"
                 "***********###**********####%%%%%%%%#=-:\n"
                 ":::::::::=*##*****+++++***######*######*******#%%%####*++****"
                 "**********#####*********####%%%%%%%%#+-:\n"
                 "::::::::=*###*****++++**##%%%##*+==+*####*****#######**+++***"
                 "***********####********####%%%%%%%%%#+--\n"
                 ":::::::=+###***********##%%%%%%#*+===+*####***#######**+++++*"
                 "***********####*****#######%%%%%%%%%%*=-\n"
                 ":::::-=*#%##***********####%%%%%%#*===+*###########***+++++++"
                 "+**********##*****########%%%%%%%%%%%*=-\n"
                 "::::-+##%##**********#***++*#%%%%%%#+==+*########****++++++++"
                 "***********#******######%%%%%%%%%%%%%*=-\n"
                 "::-=*#%%###*********###**+==+*#%%%%%#*==+*######****+++++++++"
                 "********#********#####%%%%%%%%%%%%%%%#+=\n"
                 ":-+##%%%###*********###**++===+#%%%%%#*++*######***++++++++++"
                 "*****************####%%%%%%%%%%%%%%%%#+=\n"
                 "-+#%%%%#####********####***+===+*#%%%%%*****###***+++++++++**"
                 "*****************###%%%%%%%%%%%%%%%%%#+=\n"
                 "*#%%%#######*********#####**++=++*#%%%%#*****#****+++++++****"
                 "****************###%%%%%%%%%%%%%%%%%##+=\n"
                 "#############*********######*******#%%%##********+++++*******"
                 "***************###%%%%%%%%%%%%%%%%%%#+==\n"
                 "#############******+****###############*********+++**********"
                 "**************###%%%%%%%%%%%%%%%%%%#+==-\n"
                 "######%%%#####*****+*******########**************************"
                 "*************###%%%%%%%%%%%%%%%%%%#+===-\n"
                 "######%%%%%%###**************#####***************************"
                 "***********####%%%%%%%%%%%%%%%%%%*+====-\n"
                 "#####%%%%%%%#####********************************************"
                 "***********##%%%%%%%%%%%%%%%%%%#*+===---\n"
                 "####%%%%%%%%%#####*******************************************"
                 "*********###%%%%%%%%%%%%%%%%%%#*+==-----\n"
                 "####%%%%%%%%%%#######****************************************"
                 "********###%%%%%%%%%%%%%%%%%#*+===------\n"
                 "*####%%%%%%%%%%#########*************************************"
                 "*******###%%%%%%%%%%%%%%%%#*++==--------\n"
                 "*####%%%%%%%%%%%%%########***********************************"
                 "*****######%%%%%%%%%%%%%#*++===---------\n"
                 "*####%%%%%%%%%%%%%%%########*********************************"
                 "***#########%%%%%%%%%%#**+===-----------\n"
                 "*#####%%%%%%%%%%%%%%%%#########******************************"
                 "***###########%%%%%%#*++===-------------\n"
                 "*#######%%%%%%%%%%%%%%%%###########**************************"
                 "**########***###%%#*++===---------------\n"
                 "*########%%%%%%%%%%%%%%%%%##########**********************##*"
                 "***#############**++====----------------\n"
                 "**#########%%%%%%%%%%%%%%%%######################*###########"
                 "###############*+=====------------------\n"
                 "****#########%%%%%%%%%%%%%%%%################################"
                 "############**++====--------------------\n"
                 "********#########%%%%%%%%%%%%%%##############################"
                 "#########***++====----------------------\n"
                 "**********############%%%%%%%%#############################**"
                 "****###**+++====------------------------\n"
                 "************#####################%####################%%%%#**"
                 "*******+++===---------------------------\n"
                 "**************######################################%%%%%%%##"
                 "*****++===-------------------------::---\n"
                 "*****************##################################%%%%%%%%#*"
                 "*++====----------------------------:::::\n"
                 "*******************#################################**+++++++"
                 "===------------------------------:--::::\n"
                 "********************############################*+++========="
                 "-------------------------------:::::::::\n"
                 "**********************######################**++=========----"
                 "----------------------------::::::::::::\n"
                 "***********************##################**++=========-------"
                 "---------------------:------::::::::::::\n"
                 "************************###############*++==========---------"
                 "---------------------::------:::::::::::\n"
                 "**************************###########**+==========-----------"
                 "---------------------:::::::::::::::::::\n"
                 "****************************########*++==========------------"
                 "---------------------::-::::::::::::::::");
  

  if (fs_mount(&mp) < 0) {
    perror("mount failure !!!");
    return 0;
  }

  http_server_start();
}
