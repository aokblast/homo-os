#include "drivers/homo_fs.h"
#include <assert.h>
#include <stdio.h>
#include <zephyr/fs/fs.h>
#include <zephyr/fs/fs_interface.h>
#include <zephyr/logging/log.h>
#include <zephyr/net/http/server.h>
#include <zephyr/net/http/service.h>

LOG_MODULE_REGISTER(net_http_server_sample, LOG_LEVEL_DBG);

static uint16_t http_service_port = 1919;

HTTP_SERVICE_DEFINE(homo, NULL, &http_service_port, 1, 10, NULL, NULL);

extern const unsigned char homo_fs_data_start[];
extern const unsigned char homo_fs_data_end[];
extern const unsigned char homo_fs_data_size[];

static struct homo_fs_filesystem_param fs_param;

static struct homo_fs_backend_param fs_backend_params = {
    .base_addr = homo_fs_data_start, .size = (int32_t)homo_fs_data_size};

static struct fs_mount_t mp = {
    .type = FS_TYPE_EXTERNAL_BASE,
    .storage_dev = &fs_backend_params,
    .fs_data = &fs_param,
    .flags = 0,
    .mnt_point = "/abc",
};

static int lsdir(const char *path) {
  int res;
  struct fs_dir_t dirp = {0};
  struct fs_dirent entry = {0};
  struct fs_file_t filep = {0};
  char buffer[1024] = {0};

  z_check_stack_sentinel();
  fs_dir_t_init(&dirp);
  z_check_stack_sentinel();
  
  /* Verify fs_opendir() */
  res = fs_opendir(&dirp, path);
  z_check_stack_sentinel();
  
  if (res) {
    printf("Error opening dir %s [%d]\n", path, res);
    return res;
  }

  printf("\nListing dir %s ...\n", path);
  for (;;) {
    /* Verify fs_readdir() */
    res = fs_readdir(&dirp, &entry);

    /* entry.name[0] == 0 means end-of-dir */
    if (res || entry.name[0] == 0) {
      if (res < 0) {
        printf("Error reading dir [%d]\n", res);
      }
      break;
    }

    assert(fs_open(&filep, "/abc/index.html", FS_O_READ) == 0);

    assert(fs_read(&filep, buffer, sizeof(buffer)) == entry.size);

    printf("%s\n", buffer);

    if (entry.type == FS_DIR_ENTRY_DIR) {
      printf("[DIR ] %s\n", entry.name);
    } else {
      printf("[FILE] %s (size = %zu)\n", entry.name, entry.size);
    }
  }

  /* Verify fs_closedir() */
  z_check_stack_sentinel();
  fs_closedir(&dirp);
  z_check_stack_sentinel();

  return res;
}

static int dyn_handler(struct http_client_ctx *client,
                       enum http_data_status status,
                       const struct http_request_ctx *request_ctx,
                       struct http_response_ctx *response_ctx,
                       void *user_data) {
#define MAX_TEMP_PRINT_LEN 32
  static char print_str[MAX_TEMP_PRINT_LEN];
  enum http_method method = client->method;
  static size_t processed;

  if (status == HTTP_SERVER_DATA_ABORTED) {
    LOG_DBG("Transaction aborted after %zd bytes.", processed);
    processed = 0;
    return 0;
  }
  printf("Test\n");

  processed += request_ctx->data_len;

  snprintf(print_str, sizeof(print_str), "%s received (%zd bytes)",
           http_method_str(method), request_ctx->data_len);
  LOG_HEXDUMP_DBG(request_ctx->data, request_ctx->data_len, print_str);

  if (status == HTTP_SERVER_DATA_FINAL) {
    LOG_DBG("All data received (%zd bytes).", processed);
    processed = 0;
  }

  /* Echo data back to client */
  response_ctx->body = request_ctx->data;
  response_ctx->body_len = request_ctx->data_len;
  response_ctx->final_chunk = (status == HTTP_SERVER_DATA_FINAL);

  return 0;
}

struct http_resource_detail_dynamic dyn_resource_detail = {
    .common =
        {
            .type = HTTP_RESOURCE_TYPE_DYNAMIC,
            .bitmask_of_supported_http_methods = BIT(HTTP_GET) | BIT(HTTP_POST),
        },
    .cb = dyn_handler,
    .user_data = NULL,
};

HTTP_RESOURCE_DEFINE(dyn_resource, homo, "/dynamic", &dyn_resource_detail);

int main(void) {
    printf("Homo OS v114.514 start\n");
    printf("%s\n", "######################################################################%%%%%%%%%%%%%%%%%%%%@@@@@@%%%%%\n"
	   "####################################################################%%%%%##**++++++=====++*##%%%@@@%%\n"
	   "#######################################################################*++===++**+=-:::::::--=+*##%%%\n"
	   "%##########################################################%%%%%%##%##*+==++****+=-::::-::::-++****#%\n"
	   "%%%%###################################################%%%%%%%%%%%%%##*+***#*+=::::::=++++===+****+**\n"
              "=*#%%%############################################%%%%%%#######%%%%%%%#######*+=-==----===-----------\n"
              "::=+#%%%######################################%%%%####***********###%%%%%%%%##*+++++==--:::::::::::::\n"
              ".:::-+#%%%%#################################%%%%###**++++++++++++++*###%%%%%%%%%###%##+-:::::::::::::\n"
              "::...:-+*#%%%#############################%%%%%##**++++++++++++++++++**##%%%%%%%%%%%%%*-:::::::::::::\n"
              ":::....::=+#%%%%######################%%%%%%%##***++++++++++++++++++++***##%%%%%%%%%%%*=:::::::::::::\n"
              ":::::::...:-+#%%%%########%%%%#*+==+#%%%%%##****++++++++++++++++++++++++***##%%%%%%%%%#+---::::::::::\n"
              "::::::::...::-=*#%%%%%%%#*++=-:::=*#%@%###**********++++++++++++++++++++++**##%%%%%%%%%*+===--:::::::\n"
              "::::::::::....::=+*#*+=--::::::-+#%%%#*********#####***++++++++++++++++++++**###%%%%%%%#*+=---:::::::\n"
              "::::::::::::::::::::::::....:-=*###**************####***++++++++++++++++++++***##%%%%%%%#*=--::::::::\n"
              ":::::::::::::::::::::::::::-=+****++++++++*******#####**+++++++++++++++++++++***##%%%%%%%#*=-::::::::\n"
              ":::::::::::::::::::::::::-=+*****++++++++++*******####***+++++++++++++++++++++***##%%%%%%#*+=::::::::\n"
              ":::::::::::::::::::::::-=******+++++++++++++******#####**+++++++++++++++++++++***###%%%%%%%*+-:::::::\n"
              "::::::::::::::::::::::-+*#****+++++++++++++++*****#####***++++++++++++++++++++****###%%%%%%#*=-::::::\n"
              "::::::::::::::::::::-+*##****+++++++++++++++++*****####***++++++++++++++++*********##%%%%%%%#+-::::::\n"
              "::::::::::::::::::-+*####****+++++++++++++++++++++*******++++*++++++++++************##%%%%%%#+-::::::\n"
              ":::::::::::::::::=*####****+++++++++++++++++++++++++***********+++++++++************##%%%%%%#+:::::::\n"
              ":::::::::::::::-+*###*****++++++++++*********++++++++*****####**********************###%%%%%#+-::::::\n"
              ":::::::::::::-=+###*****+++++++++++******###**++++++****########*********************##%%%%%%*=::::::\n"
              "::::::::::::-+*###*****++++++++++*******##%%#*+++++****##############***************####%%%%%%*=:::::\n"
              ":::::::::::-+###******++++++++**********#####*********#***#######%%%##***************###%%%%%%#*=-:::\n"
              ":::::::::::=*##*****+++++++****************#########**************#####**************####%%%%%%%*=-::\n"
              "::::::::::=*##*****++++++****########********##%%#####******************###**********####%%%%%%%%#=-:\n"
              ":::::::::=*##*****+++++***######*######*******#%%%####*++**************#####*********####%%%%%%%%#+-:\n"
              "::::::::=*###*****++++**##%%%##*+==+*####*****#######**+++**************####********####%%%%%%%%%#+--\n"
              ":::::::=+###***********##%%%%%%#*+===+*####***#######**+++++************####*****#######%%%%%%%%%%*=-\n"
              ":::::-=*#%##***********####%%%%%%#*===+*###########***++++++++**********##*****########%%%%%%%%%%%*=-\n"
              "::::-+##%##**********#***++*#%%%%%%#+==+*########****++++++++***********#******######%%%%%%%%%%%%%*=-\n"
              "::-=*#%%###*********###**+==+*#%%%%%#*==+*######****+++++++++********#********#####%%%%%%%%%%%%%%%#+=\n"
              ":-+##%%%###*********###**++===+#%%%%%#*++*######***++++++++++*****************####%%%%%%%%%%%%%%%%#+=\n"
              "-+#%%%%#####********####***+===+*#%%%%%*****###***+++++++++*******************###%%%%%%%%%%%%%%%%%#+=\n"
              "*#%%%#######*********#####**++=++*#%%%%#*****#****+++++++********************###%%%%%%%%%%%%%%%%%##+=\n"
              "#############*********######*******#%%%##********+++++**********************###%%%%%%%%%%%%%%%%%%#+==\n"
              "#############******+****###############*********+++************************###%%%%%%%%%%%%%%%%%%#+==-\n"
              "######%%%#####*****+*******########***************************************###%%%%%%%%%%%%%%%%%%#+===-\n"
              "######%%%%%%###**************#####**************************************####%%%%%%%%%%%%%%%%%%*+====-\n"
              "#####%%%%%%%#####*******************************************************##%%%%%%%%%%%%%%%%%%#*+===---\n"
              "####%%%%%%%%%#####****************************************************###%%%%%%%%%%%%%%%%%%#*+==-----\n"
              "####%%%%%%%%%%#######************************************************###%%%%%%%%%%%%%%%%%#*+===------\n"
              "*####%%%%%%%%%%#########********************************************###%%%%%%%%%%%%%%%%#*++==--------\n"
              "*####%%%%%%%%%%%%%########****************************************######%%%%%%%%%%%%%#*++===---------\n"
              "*####%%%%%%%%%%%%%%%########************************************#########%%%%%%%%%%#**+===-----------\n"
              "*#####%%%%%%%%%%%%%%%%#########*********************************###########%%%%%%#*++===-------------\n"
              "*#######%%%%%%%%%%%%%%%%###########****************************########***###%%#*++===---------------\n"
              "*########%%%%%%%%%%%%%%%%%##########**********************##****#############**++====----------------\n"
              "**#########%%%%%%%%%%%%%%%%######################*##########################*+=====------------------\n"
              "****#########%%%%%%%%%%%%%%%%############################################**++====--------------------\n"
              "********#########%%%%%%%%%%%%%%#######################################***++====----------------------\n"
              "**********############%%%%%%%%#############################******###**+++====------------------------\n"
              "************#####################%####################%%%%#*********+++===---------------------------\n"
              "**************######################################%%%%%%%##*****++===-------------------------::---\n"
              "*****************##################################%%%%%%%%#**++====----------------------------:::::\n"
              "*******************#################################**+++++++===------------------------------:--::::\n"
              "********************############################*+++=========-------------------------------:::::::::\n"
              "**********************######################**++=========--------------------------------::::::::::::\n"
              "***********************##################**++=========----------------------------:------::::::::::::\n"
              "************************###############*++==========------------------------------::------:::::::::::\n"
              "**************************###########**+==========--------------------------------:::::::::::::::::::\n"
	       "****************************########*++==========---------------------------------::-::::::::::::::::");
  z_check_stack_sentinel();
  printf("homo start %x\n", homo_fs_data_start);
  z_check_stack_sentinel();
  
  printf("homo magic %x\n", *(uint32_t *)homo_fs_data_start);
  z_check_stack_sentinel();
  
  printf("homo size %x\n", homo_fs_data_size);
  z_check_stack_sentinel();
  
  if (fs_mount(&mp) < 0) {
    perror("mount failure !!!");
    return 0;
  }
  z_check_stack_sentinel();
  
  printf("mount success!!");
  z_check_stack_sentinel();
  
  lsdir("/abc/");
  z_check_stack_sentinel();
  
  http_server_start();
}
